<script>
  // ====== 設定値（ここを変えればルール調整できます） ======
  const MAX_TIME_MS = 10000;         // 絵札表示からの制限時間（ミリ秒）
  const POINTS_PER_SECOND = 10;      // 1秒あたりの加点
  const WRONG_PENALTY = -20;         // 不正解 & 時間切れペナルティ

  // ====== 使うかなの一覧 ======
  // 「こ」はロジック上は「こ」として扱うが、画像は ko.jpg を使う
  const kanaList = [
    "あ","い","う","え","お",
    "か","き","く","け","こ",
    "さ","し","す","せ","そ",
    "た","ち","つ","て","と",
    "な","に","ぬ","ね","の",
    "は","ひ","ふ","へ","ほ",
    "ま","み","む","め","も",
    "や","ゆ","よ",
    "ら","り","る","れ","ろ",
    "わ","を","ん"
  ];

  // かな → ファイル名のキー（.jpg は後で付ける）
  const kanaToFileKey = {
    "あ": "a",
    "い": "i",
    "う": "u",
    "え": "e",
    "お": "o",

    "か": "ka",
    "き": "ki",
    "く": "ku",
    "け": "ke",
    "こ": "ko",   // 札は「ご」だがファイル名は ko.jpg

    "さ": "sa",
    "し": "si",
    "す": "su",
    "せ": "se",
    "そ": "so",

    "た": "ta",
    "ち": "ti",
    "つ": "tu",
    "て": "te",
    "と": "to",

    "な": "na",
    "に": "ni",
    "ぬ": "nu",
    "ね": "ne",
    "の": "no",

    "は": "ha",
    "ひ": "hi",
    "ふ": "hu",
    "へ": "he",
    "ほ": "ho",

    "ま": "ma",
    "み": "mi",
    "む": "mu",
    "め": "me",
    "も": "mo",

    "や": "ya",
    "ゆ": "yu",
    "よ": "yo",

    "ら": "ra",
    "り": "ri",
    "る": "ru",
    "れ": "re",
    "ろ": "ro",

    "わ": "wa",
    "を": "wo",
    "ん": "n"
  };

  // ====== 問題データ ======
  // 今はサンプル1問だけ。ここに今後 PDF に合わせて全問を追加していく。
  const questions = [
    {
      id: "a",
      kana: "あ",                             // 先頭の文字
      leadingKana: "あ",                      // 最初にドンと出す1文字
      fullPhrase: "あ：あかんもんはあかん",  // 読み札
      explanation: "【サンプル】ここに「あ：あかんもんはあかん」の解説文を入れてください。"
    }
    // ここに「い」「う」…分を追加予定
  ];

  // ====== 状態管理用変数 ======
  let currentIndex = 0;         // 出題順配列のインデックス
  let questionOrder = [];       // 出題順（questions のインデックスをシャッフルしたもの）
  let score = 0;
  let canAnswer = false;
  let hasAnswered = false;
  let timerId = null;
  let questionStartTime = null;

  // ====== DOM 取得 ======
  const leadingKanaEl   = document.getElementById("leadingKana");
  const fullPhraseEl    = document.getElementById("fullPhrase");
  const cardsGridEl     = document.getElementById("cardsGrid");
  const timerTextEl     = document.getElementById("timerText");
  const scoreTextEl     = document.getElementById("scoreText");
  const messageEl       = document.getElementById("message");
  const explanationEl   = document.getElementById("explanation");
  const nextButtonEl    = document.getElementById("nextButton");
  const questionCountEl = document.getElementById("questionCount");
  const progressEl      = document.getElementById("progress");
  const finalResultEl   = document.getElementById("finalResult");

  // ====== ユーティリティ ======
  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function resetTimer() {
    if (timerId !== null) {
      clearInterval(timerId);
      timerId = null;
    }
    timerTextEl.textContent = "--.-";
  }

  function updateTimer() {
    if (!questionStartTime) return;
    const elapsed   = Date.now() - questionStartTime;
    const remaining = Math.max(0, MAX_TIME_MS - elapsed);
    const sec       = remaining / 1000;
    timerTextEl.textContent = sec.toFixed(1);

    if (remaining <= 0 && !hasAnswered) {
      handleTimeout();
    }
  }

  function startTimer() {
    resetTimer();
    questionStartTime = Date.now();
    timerId = setInterval(updateTimer, 100);
  }

  function stopTimer() {
    if (timerId !== null) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function setMessage(text, type) {
    messageEl.textContent = text;
    messageEl.classList.remove("ok", "ng");
    if (type === "ok") messageEl.classList.add("ok");
    if (type === "ng") messageEl.classList.add("ng");
  }

  function getCurrentQuestion() {
    const qIndex = questionOrder[currentIndex];
    return questions[qIndex];
  }

  // ====== カード（正解＋不正解3枚）を作る ======
  function buildCardsForQuestion(q) {
    const kana = q.kana;  // 例：「あ」「こ」など

    // 正解カード
    const correctKey = kanaToFileKey[kana];
    const correctCard = {
      src: `images/${correctKey}.jpg`,
      alt: `${kana} の札`,
      isCorrect: true
    };

    // 不正解用のかな候補（自分以外）
    const wrongKanaPool = kanaList.filter(k => k !== kana);
    const wrongKanaSelected = shuffleArray(wrongKanaPool).slice(0, 3);

    const wrongCards = wrongKanaSelected.map(k => {
      const key = kanaToFileKey[k];
      return {
        src: `images/${key}.jpg`,
        alt: `${k} の札`,
        isCorrect: false
      };
    });

    // 正解＋不正解をまとめてシャッフル
    const allCards = shuffleArray([correctCard, ...wrongCards]);
    return allCards;
  }

  // ====== 問題表示ロジック ======
  function showQuestion() {
    const q = getCurrentQuestion();
    if (!q) return;

    // 状態リセット
    canAnswer = false;
    hasAnswered = false;
    resetTimer();
    setMessage("", null);
    explanationEl.style.display = "none";
    explanationEl.textContent = "";
    nextButtonEl.style.display = "none";
    finalResultEl.textContent = "";

    // 進捗表示
    const questionNumber = currentIndex + 1;
    questionCountEl.textContent = `第${questionNumber}問`;
    progressEl.textContent = `${questionNumber} / ${questions.length}`;

    // 0秒：先頭1文字だけ表示
    leadingKanaEl.textContent = q.leadingKana;
    fullPhraseEl.textContent = "";

    // カードはいったん消す
    cardsGridEl.innerHTML = "";

    // 1秒後：カード4枚を表示して回答可能に＆タイマー開始
    setTimeout(() => {
      const cards = buildCardsForQuestion(q);
      renderCards(cards);
      canAnswer = true;
      startTimer();
    }, 1000);

    // 2秒後：フルのセリフを表示
    setTimeout(() => {
      fullPhraseEl.textContent = q.fullPhrase;
    }, 2000);
  }

  function renderCards(cards) {
    cardsGridEl.innerHTML = "";

    cards.forEach(card => {
      const cardEl = document.createElement("div");
      cardEl.className = "card";
      cardEl.dataset.correct = card.isCorrect ? "1" : "0";

      const coverEl = document.createElement("div");
      coverEl.className = "kana-cover";

      const imgEl = document.createElement("img");
      imgEl.src = card.src;
      imgEl.alt = card.alt;

      cardEl.appendChild(imgEl);
      cardEl.appendChild(coverEl);

      cardEl.addEventListener("click", () => {
        handleAnswer(cardEl, card.isCorrect);
      });

      cardsGridEl.appendChild(cardEl);
    });
  }

  // ====== 回答処理 ======
  function handleAnswer(cardEl, isCorrect) {
    if (!canAnswer || hasAnswered) return;

    hasAnswered = true;
    canAnswer = false;
    stopTimer();

    const elapsed   = Date.now() - questionStartTime;
    const remaining = Math.max(0, MAX_TIME_MS - elapsed);
    let deltaScore  = 0;

    const allCards = cardsGridEl.querySelectorAll(".card");
    allCards.forEach(c => c.classList.add("disabled"));

    // 正解カードをハイライト
    allCards.forEach(c => {
      if (c.dataset.correct === "1") {
        c.classList.add("correct");
      }
    });

    if (isCorrect) {
      const sec = remaining / 1000;
      deltaScore = Math.round(sec) * POINTS_PER_SECOND;
      score += deltaScore;

      cardEl.classList.add("correct");
      setMessage(`正解！ +${deltaScore} 点`, "ok");
    } else {
      deltaScore = WRONG_PENALTY;
      score += deltaScore;
      cardEl.classList.add("wrong");
      setMessage(`残念… ${WRONG_PENALTY} 点`, "ng");
    }

    scoreTextEl.textContent = score.toString();

    // 解説表示
    const q = getCurrentQuestion();
    explanationEl.textContent = q.explanation;
    explanationEl.style.display = "block";

    // 最後の問題かどうかでボタンの文言変更
    if (currentIndex < questionOrder.length - 1) {
      nextButtonEl.textContent = "次の問題へ";
    } else {
      nextButtonEl.textContent = "結果を見る";
    }
    nextButtonEl.style.display = "inline-block";
  }

  function handleTimeout() {
    if (hasAnswered) return;
    hasAnswered = true;
    canAnswer = false;
    stopTimer();

    const allCards = cardsGridEl.querySelectorAll(".card");
    allCards.forEach(c => c.classList.add("disabled"));

    allCards.forEach(c => {
      if (c.dataset.correct === "1") {
        c.classList.add("correct");
      }
    });

    score += WRONG_PENALTY;
    scoreTextEl.textContent = score.toString();
    setMessage(`時間切れ！ ${WRONG_PENALTY} 点`, "ng");

    const q = getCurrentQuestion();
    explanationEl.textContent = q.explanation;
    explanationEl.style.display = "block";

    if (currentIndex < questionOrder.length - 1) {
      nextButtonEl.textContent = "次の問題へ";
    } else {
      nextButtonEl.textContent = "結果を見る";
    }
    nextButtonEl.style.display = "inline-block";
  }

  function goToNext() {
    if (currentIndex < questionOrder.length - 1) {
      currentIndex += 1;
      showQuestion();
    } else {
      finalResultEl.textContent =
        `全${questions.length}問終了！ あなたのあきんどスコアは ${score} 点です。`;
      nextButtonEl.style.display = "none";
    }
  }

  nextButtonEl.addEventListener("click", goToNext);

  // ====== ゲーム開始 ======
  function startGame() {
    score = 0;
    scoreTextEl.textContent = "0";

    // 出題順をランダムに決定
    const indices = [];
    for (let i = 0; i < questions.length; i++) {
      indices.push(i);
    }
    questionOrder = shuffleArray(indices);
    currentIndex = 0;

    showQuestion();
  }

  // 初期化
  startGame();
</script>
