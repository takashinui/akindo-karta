<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>あきんどカルタゲーム</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 12px;
    }

    .game-container {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 16px 16px 20px;
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    header p {
      font-size: 12px;
      color: #666;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 8px;
      color: #555;
    }

    .status-bar span {
      min-width: 80px;
    }

    .leading-kana {
      text-align: center;
      margin: 8px 0;
      font-size: 40px;
      font-weight: bold;
    }

    .full-phrase {
      text-align: center;
      margin: 4px 0 10px;
      min-height: 24px;
      font-size: 14px;
      color: #333;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }

    .card {
      position: relative;
      background: #fafafa;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }

    .card.disabled {
      cursor: default;
      opacity: 0.7;
    }

    .card:hover:not(.disabled) {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .card.correct {
      border-color: #2e7d32;
    }

    .card.wrong {
      border-color: #c62828;
    }

    .kana-cover {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 56px;
      height: 56px;
      background: #ffffff;
      box-shadow: 0 0 4px rgba(255,255,255,0.8);
    }

    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin: 6px 0;
      color: #555;
    }

    .timer {
      font-variant-numeric: tabular-nums;
    }

    .score {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    .message {
      min-height: 20px;
      font-size: 13px;
      margin: 4px 0;
    }

    .message.ok {
      color: #2e7d32;
    }

    .message.ng {
      color: #c62828;
    }

    .explanation {
      margin-top: 6px;
      font-size: 12px;
      line-height: 1.5;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 8px;
      max-height: 140px;
      overflow-y: auto;
    }

    .buttons {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: opacity 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn:not(:disabled):active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0,0,0,0.18);
    }

    .final-result {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
      color: #333;
    }

    @media (max-width: 360px) {
      .game-container {
        padding: 12px;
      }
      .leading-kana {
        font-size: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <header>
      <h1>あきんどカルタ</h1>
      <p>「あきんどの精神」を学ぶカルタゲーム</p>
    </header>

    <div class="status-bar">
      <span id="questionCount">第1問</span>
      <span id="progress"></span>
    </div>

    <div class="leading-kana" id="leadingKana">あ</div>
    <div class="full-phrase" id="fullPhrase"></div>

    <div class="cards-grid" id="cardsGrid">
      <!-- 絵札カードをここにJSで生成 -->
    </div>

    <div class="info-bar">
      <span class="timer">タイマー：<span id="timerText">--.-</span> 秒</span>
      <span class="score">スコア：<span id="scoreText">0</span> 点</span>
    </div>

    <div class="message" id="message"></div>

    <div class="explanation" id="explanation" style="display:none;"></div>

    <div class="buttons">
      <button class="btn" id="nextButton" style="display:none;">次の問題へ</button>
    </div>

    <div class="final-result" id="finalResult"></div>
  </div>

  <script>
    // ====== 設定値 ======
    const MAX_TIME_MS = 10000;         // 絵札表示からの制限時間（ミリ秒）
    const POINTS_PER_SECOND = 10;      // 1秒あたりの加点
    const WRONG_PENALTY = -20;         // 不正解 & 時間切れペナルティ

    // ====== 使うかなの一覧 ======
    const kanaList = [
      "あ","い","う","え","お",
      "か","き","く","け","こ",
      "さ","し","す","せ","そ",
      "た","ち","つ","て","と",
      "な","に","ぬ","ね","の",
      "は","ひ","ふ","へ","ほ",
      "ま","み","む","め","も",
      "や","ゆ","よ",
      "ら","り","る","れ","ろ",
      "わ","を","ん"
    ];

    // かな → ファイル名のキー（.jpg は後で付ける）
    const kanaToFileKey = {
      "あ": "a",
      "い": "i",
      "う": "u",
      "え": "e",
      "お": "o",

      "か": "ka",
      "き": "ki",
      "く": "ku",
      "け": "ke",
      "こ": "ko",   // 札は「ご」だがファイル名は ko.jpg

      "さ": "sa",
      "し": "si",
      "す": "su",
      "せ": "se",
      "そ": "so",

      "た": "ta",
      "ち": "ti",
      "つ": "tu",
      "て": "te",
      "と": "to",

      "な": "na",
      "に": "ni",
      "ぬ": "nu",
      "ね": "ne",
      "の": "no",

      "は": "ha",
      "ひ": "hi",
      "ふ": "hu",
      "へ": "he",
      "ほ": "ho",

      "ま": "ma",
      "み": "mi",
      "む": "mu",
      "め": "me",
      "も": "mo",

      "や": "ya",
      "ゆ": "yu",
      "よ": "yo",

      "ら": "ra",
      "り": "ri",
      "る": "ru",
      "れ": "re",
      "ろ": "ro",

      "わ": "wa",
      "を": "wo",
      "ん": "n"
    };

    // ====== 問題データ（今はサンプル1問だけ） ======
    const questions = [
      {
        id: "a",
        kana: "あ",
        leadingKana: "あ",
        fullPhrase: "あ：あかんもんはあかん",
        explanation: "【サンプル】ここに「あ：あかんもんはあかん」の解説文を入れてください。"
      }
      // ここに「い」「う」…を後で追加
    ];

    // ====== 状態管理 ======
    let currentIndex = 0;         // 出題順インデックス
    let questionOrder = [];       // 出題順（questions のインデックスシャッフル）
    let score = 0;
    let canAnswer = false;
    let hasAnswered = false;
    let timerId = null;
    let questionStartTime = null;

    // ====== DOM ======
    const leadingKanaEl   = document.getElementById("leadingKana");
    const fullPhraseEl    = document.getElementById("fullPhrase");
    const cardsGridEl     = document.getElementById("cardsGrid");
    const timerTextEl     = document.getElementById("timerText");
    const scoreTextEl     = document.getElementById("scoreText");
    const messageEl       = document.getElementById("message");
    const explanationEl   = document.getElementById("explanation");
    const nextButtonEl    = document.getElementById("nextButton");
    const questionCountEl = document.getElementById("questionCount");
    const progressEl      = document.getElementById("progress");
    const finalResultEl   = document.getElementById("finalResult");

    // ====== ユーティリティ ======
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function resetTimer() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
      timerTextEl.textContent = "--.-";
    }

    function updateTimer() {
      if (!questionStartTime) return;
      const elapsed   = Date.now() - questionStartTime;
      const remaining = Math.max(0, MAX_TIME_MS - elapsed);
      const sec       = remaining / 1000;
      timerTextEl.textContent = sec.toFixed(1);

      if (remaining <= 0 && !hasAnswered) {
        handleTimeout();
      }
    }

    function startTimer() {
      resetTimer();
      questionStartTime = Date.now();
      timerId = setInterval(updateTimer, 100);
    }

    function stopTimer() {
      if (timerId !== null) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function setMessage(text, type) {
      messageEl.textContent = text;
      messageEl.classList.remove("ok", "ng");
      if (type === "ok") messageEl.classList.add("ok");
      if (type === "ng") messageEl.classList.add("ng");
    }

    function getCurrentQuestion() {
      const qIndex = questionOrder[currentIndex];
      return questions[qIndex];
    }

    // ====== カード（正解＋不正解3枚）を作る ======
    function buildCardsForQuestion(q) {
      const kana = q.kana;

      const correctKey = kanaToFileKey[kana];
      const correctCard = {
        src: `images/${correctKey}.jpg`,
        alt: `${kana} の札`,
        isCorrect: true
      };

      const wrongKanaPool = kanaList.filter(k => k !== kana);
      const wrongKanaSelected = shuffleArray(wrongKanaPool).slice(0, 3);

      const wrongCards = wrongKanaSelected.map(k => {
        const key = kanaToFileKey[k];
        return {
          src: `images/${key}.jpg`,
          alt: `${k} の札`,
          isCorrect: false
        };
      });

      return shuffleArray([correctCard, ...wrongCards]);
    }

    // ====== 問題表示 ======
    function showQuestion() {
      const q = getCurrentQuestion();
      if (!q) return;

      canAnswer = false;
      hasAnswered = false;
      resetTimer();
      setMessage("", null);
      explanationEl.style.display = "none";
      explanationEl.textContent = "";
      nextButtonEl.style.display = "none";
      finalResultEl.textContent = "";

      const questionNumber = currentIndex + 1;
      questionCountEl.textContent = `第${questionNumber}問`;
      progressEl.textContent = `${questionNumber} / ${questions.length}`;

      leadingKanaEl.textContent = q.leadingKana;
      fullPhraseEl.textContent = "";
      cardsGridEl.innerHTML = "";

      setTimeout(() => {
        const cards = buildCardsForQuestion(q);
        renderCards(cards);
        canAnswer = true;
        startTimer();
      }, 1000);

      setTimeout(() => {
        fullPhraseEl.textContent = q.fullPhrase;
      }, 2000);
    }

    function renderCards(cards) {
      cardsGridEl.innerHTML = "";

      cards.forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";
        cardEl.dataset.correct = card.isCorrect ? "1" : "0";

        const coverEl = document.createElement("div");
        coverEl.className = "kana-cover";

        const imgEl = document.createElement("img");
        imgEl.src = card.src;
        imgEl.alt = card.alt;

        cardEl.appendChild(imgEl);
        cardEl.appendChild(coverEl);

        cardEl.addEventListener("click", () => {
          handleAnswer(cardEl, card.isCorrect);
        });

        cardsGridEl.appendChild(cardEl);
      });
    }

    // ====== 回答処理 ======
    function handleAnswer(cardEl, isCorrect) {
      if (!canAnswer || hasAnswered) return;

      hasAnswered = true;
      canAnswer = false;
      stopTimer();

      const elapsed   = Date.now() - questionStartTime;
      const remaining = Math.max(0, MAX_TIME_MS - elapsed);
      let deltaScore  = 0;

      const allCards = cardsGridEl.querySelectorAll(".card");
      allCards.forEach(c => c.classList.add("disabled"));

      allCards.forEach(c => {
        if (c.dataset.correct === "1") {
          c.classList.add("correct");
        }
      });

      if (isCorrect) {
        const sec = remaining / 1000;
        deltaScore = Math.round(sec) * POINTS_PER_SECOND;
        score += deltaScore;

        cardEl.classList.add("correct");
        setMessage(`正解！ +${deltaScore} 点`, "ok");
      } else {
        deltaScore = WRONG_PENALTY;
        score += deltaScore;
        cardEl.classList.add("wrong");
        setMessage(`残念… ${WRONG_PENALTY} 点`, "ng");
      }

      scoreTextEl.textContent = score.toString();

      const q = getCurrentQuestion();
      explanationEl.textContent = q.explanation;
      explanationEl.style.display = "block";

      if (currentIndex < questionOrder.length - 1) {
        nextButtonEl.textContent = "次の問題へ";
      } else {
        nextButtonEl.textContent = "結果を見る";
      }
      nextButtonEl.style.display = "inline-block";
    }

    function handleTimeout() {
      if (hasAnswered) return;
      hasAnswered = true;
      canAnswer = false;
      stopTimer();

      const allCards = cardsGridEl.querySelectorAll(".card");
      allCards.forEach(c => c.classList.add("disabled"));

      allCards.forEach(c => {
        if (c.dataset.correct === "1") {
          c.classList.add("correct");
        }
      });

      score += WRONG_PENALTY;
      scoreTextEl.textContent = score.toString();
      setMessage(`時間切れ！ ${WRONG_PENALTY} 点`, "ng");

      const q = getCurrentQuestion();
      explanationEl.textContent = q.explanation;
      explanationEl.style.display = "block";

      if (currentIndex < questionOrder.length - 1) {
        nextButtonEl.textContent = "次の問題へ";
      } else {
        nextButtonEl.textContent = "結果を見る";
      }
      nextButtonEl.style.display = "inline-block";
    }

    function goToNext() {
      if (currentIndex < questionOrder.length - 1) {
        currentIndex += 1;
        showQuestion();
      } else {
        finalResultEl.textContent =
          `全${questions.length}問終了！ あなたのあきんどスコアは ${score} 点です。`;
        nextButtonEl.style.display = "none";
      }
    }

    nextButtonEl.addEventListener("click", goToNext);

    // ====== ゲーム開始 ======
    function startGame() {
      score = 0;
      scoreTextEl.textContent = "0";

      const indices = [];
      for (let i = 0; i < questions.length; i++) {
        indices.push(i);
      }
      questionOrder = shuffleArray(indices);
      currentIndex = 0;

      showQuestion();
    }

    startGame();
  </script>
</body>
</html>
